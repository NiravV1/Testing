repeat
    wait()
until game:IsLoaded()

repeat
    wait()
until game:IsLoaded()

local library = {
    flags = {},
    accent = Color3.fromRGB(140, 60,255),
    outline = { Color3.fromRGB(140, 60,255), Color3.fromRGB(223, 57, 137) },
    toggled = true,
    -- Registry to sync UI with Script Logic
    registry = {
        toggles = {},
        sliders = {},
        dropdowns = {}
    }
}

local services = setmetatable({}, {
    __index = function(_, service)
        return game:GetService(service)
    end
})

local HttpService = game:GetService("HttpService")

local utility = {}

function utility.create(class, properties)
    local obj = Instance.new(class)
    for prop, v in next, properties do
        obj[prop] = v
    end
    return obj
end

function utility.gradient(colors)
    local colortbl = {}
    for i, color in next, colors do
        table.insert(colortbl, ColorSequenceKeypoint.new((i -1) / (#colors - 1), color))
    end
    return ColorSequence.new(colortbl)
end

function utility.tween(obj, info, props)
    local tween = services.TweenService:Create(obj, TweenInfo.new(unpack(info)), props)
    tween:Play()
    return tween
end

function utility.stroke(obj, color, thickness)
    local stroke = Instance.new("UIStroke")
    stroke.Color = color or Color3.fromRGB(50,50,50)
    stroke.Thickness = thickness or 1
    stroke.Transparency = 0.5
    stroke.Parent = obj
    return stroke
end

function utility.dragify(object, inputFrame)
    local dragging, dragInput, dragStart, startPos
    local targetInput = inputFrame or object

    targetInput.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = object.Position

            local connection
            connection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    connection:Disconnect()
                end
            end)
        end
    end)
    targetInput.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    services.UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            object.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

-- ==========================================
-- CONFIG SYSTEM LOGIC
-- ==========================================
local ConfigFolder = "ZalHub/Configs"

-- Internal references to update UI
local configDropdownFrame = nil 
local configDropdownList = nil
local refreshConfigCallback = nil

local function ensureDirectory()
    if makefolder then
        if not isfolder(ConfigFolder) then
            makefolder(ConfigFolder)
        end
    else
        warn("ZalHub: Executor does not support file I/O (makefolder). Config system disabled.")
    end
end

local function getFiles()
    local list = {}
    if listfiles then
        local files = listfiles(ConfigFolder)
        for _, v in pairs(files) do
            if v:match("%.json$") then
                local name = v:gsub(ConfigFolder .. "\\", ""):gsub("%.json$", "")
                table.insert(list, name)
            end
        end
    return list
end

local function saveConfig(name)
    if not writefile then return false end
    ensureDirectory()
    local jsonStr = HttpService:JSONEncode(library.flags)
    writefile(ConfigFolder .. "/" .. name .. ".json", jsonStr)
    return true
end

local function deleteConfig(name)
    if delfile then
        local path = ConfigFolder .. "/" .. name .. ".json"
        if isfile(path) then
            delfile(path)
            
            -- Check if autoload is this file and remove it
            if isfile(ConfigFolder .. "/autoload.txt") then
                local auto = readfile(ConfigFolder .. "/autoload.txt")
                if auto == name .. ".json" then
                    delfile(ConfigFolder .. "/autoload.txt")
                end
            end
        return true
    end
    return false
end

local function setAutoload(name)
    if not writefile then return end
    ensureDirectory()
    writefile(ConfigFolder .. "/autoload.txt", name .. ".json")
end

local function getAutoload()
    if not readfile then return nil end
    ensureDirectory()
    if isfile(ConfigFolder .. "/autoload.txt") then
        local content = readfile(ConfigFolder .. "/autoload.txt")
        return content:gsub("%.json$", "")
    end
    return nil
end

local function loadConfig(name)
    if not readfile then return false end
    ensureDirectory()
    local path = ConfigFolder .. "/" .. name .. ".json"
    if isfile(path) then
        local content = readfile(path)
        local success, data = pcall(function() return HttpService:JSONDecode(content) end)
        if success and type(data) == "table" then
            -- Update Flags
            for flag, value in pairs(data) do
                library.flags[flag] = value
                
                -- Update Toggles
                if library.registry.toggles[flag] then
                    local reg = library.registry.toggles[flag]
                    reg.fill.BackgroundTransparency = value and 0 or 1
                    -- SYNC LOGIC: Update getgenv variable if mapped
                    if getgenv().Registry and getgenv().Registry[flag] then
                        getgenv()[getgenv().Registry[flag]] = value
                    end
                    pcall(reg.callback, value)
                end
                
                -- Update Sliders
                if library.registry.sliders[flag] then
                    local reg = library.registry.sliders[flag]
                    local clamped = math.clamp(value, reg.min, reg.max)
                    local perc = (clamped - reg.min) / (reg.max - reg.min)
                    reg.fill.Size = UDim2.new(perc, 0, 1, 0)
                    reg.val.Text = string.format("%.2f", clamped)
                    
                    -- SYNC LOGIC: Update getgenv variable if mapped
                    if getgenv().Registry and getgenv().Registry[flag] then
                        local varName = getgenv().Registry[flag]
                        -- Special case for Builder (Table update)
                        if type(getgenv()[varName]) == "table" then
                            local valNum = tonumber(clamped) or 0
                            local subVar = string.sub(varName, 1, -1) or "X" -- Remove last char for generic logic if needed, or handle specifically
                            -- Builder Logic handled in Main Script, but we trigger slider callback which handles it
                            pcall(reg.callback, value) -- Call original callback to update visuals and other internal checks
                        else
                            getgenv()[varName] = clamped
                        end
                    end
                    pcall(reg.callback, value)
                end

                -- Update Dropdowns
                if library.registry.dropdowns[flag] then
                    local reg = library.registry.dropdowns[flag]
                    reg.btn.Text = tostring(value)
                    
                    -- SYNC LOGIC: Update getgenv variable
                    if getgenv().Registry and getgenv().Registry[flag] then
                        getgenv()[getgenv().Registry[flag]] = value
                    end
                    pcall(reg.callback, value)
                end
            end
            return true
        end
    end
    return false
end

local notifyHolder = game:GetService("CoreGui"):FindFirstChild("ZalHub_NotifyHolder")
if not notifyHolder then
    notifyHolder = utility.create("ScreenGui", {
        Name = "ZalHub_NotifyHolder",
        Parent = game:GetService("CoreGui"),
        ResetOnSpawn = false,
        IgnoreGuiInset = true
    })
    local layout = utility.create("UIListLayout", {
        Parent = notifyHolder,
        Padding = UDim.new(0, 8),
        SortOrder = Enum.SortOrder.LayoutOrder,
        VerticalAlignment = Enum.VerticalAlignment.Bottom,
        HorizontalAlignment = Enum.HorizontalAlignment.Right
    })

    local padding = utility.create("UIPadding", {
        Parent = notifyHolder,
        PaddingBottom = UDim.new(0, 80),
        PaddingRight = UDim.new(0, 10)
    })
end

function library:Notify(options)
    if not notifyHolder then return end

    local notifyFrame = utility.create("Frame", {
        Size = UDim2.new(0, 300, 0, 0),
        Position = UDim2.new(1, 330, 1, 0),
        BackgroundColor3 = Color3.fromRGB(15, 15, 15),
        BorderSizePixel = 0,
        Parent = notifyHolder,
        AnchorPoint = Vector2.new(1,1)
    })
    notifyFrame.AutomaticSize = Enum.AutomaticSize.Y
    utility.stroke(notifyFrame, library.accent, 1)

    local border = utility.create("Frame", {
        Size = UDim2.new(1, 4, 1, 4),
        Position = UDim2.new(0, -2, 0, -2),
        BackgroundColor3 = Color3.fromRGB(255,255,255),
        BorderSizePixel = 0,
        ZIndex = 0,
        Parent = notifyFrame
    })
    local borderGradient = utility.create("UIGradient", {
        Rotation = 45,
        Color = utility.gradient(library.outline),
        Parent = border
    })

    local contentFrame = utility.create("Frame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = Color3.fromRGB(15, 15, 15),
        BorderSizePixel = 0,
        Parent = notifyFrame
    })
    contentFrame.AutomaticSize = Enum.AutomaticSize.Y

    local list = utility.create("UIListLayout", {
        Parent = contentFrame,
        Padding = UDim.new(0, 6)
    })

    utility.create("TextLabel", {
        Size = UDim2.new(1, -12, 0, 24),
        Position = UDim2.new(0, 6, 0, 6),
        BackgroundTransparency = 1,
        Text = options.Title or "Notification",
        TextColor3 = library.accent,
        TextSize = 15,
        Font = Enum.Font.Code,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 2,
        Parent = contentFrame
    })

    utility.create("TextLabel", {
        Size = UDim2.new(1, -12, 0, 0),
        Position = UDim2.new(0, 6, 0, 0),
        BackgroundTransparency = 1,
        Text = options.Content or "Message",
        TextColor3 = Color3.fromRGB(200, 200, 200),
        TextSize = 13,
        Font = Enum.Font.Code,
        TextWrapped = true,
        TextXAlignment = Enum.TextXAlignment.Left,
        AutomaticSize = Enum.AutomaticSize.Y,
        ZIndex = 2,
        Parent = contentFrame
    })

    local duration = options.Duration or 5

    utility.tween(notifyFrame, {0.4, Enum.EasingStyle.Back}, {Position = UDim2.new(1, -10, 1, -10)})

    task.spawn(function()
        task.wait(duration)
        utility.tween(notifyFrame, {0.4, Enum.EasingStyle.Quad}, {Position = UDim2.new(1, 330, 1, 0)})
        task.wait(0.5)
        notifyFrame:Destroy()
    end)
end

function library:Window(name)
    local gui = utility.create("ScreenGui", {
        Name = "ZalHub",
        Parent = game:GetService("CoreGui") or game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui"),
        ResetOnSpawn = false
    })

    local holder = utility.create("Frame", {
        Name = "Holder",
        Size = UDim2.new(0, 750, 0, 550),
        Position = UDim2.new(0.5, -375, 0.5, -275),
        BackgroundColor3 = Color3.fromRGB(10, 10, 10),
        BorderSizePixel = 0,
        Parent = gui
    })

    -- TOGGLE GUI / WATERMARK
    local toggleGui = Instance.new("ScreenGui")
    toggleGui.Name = "ZalHub_Toggle"
    toggleGui.Parent = game:GetService("CoreGui")
    toggleGui.ResetOnSpawn = false
    toggleGui.DisplayOrder = 999

    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Name = "ToggleBtn"
    toggleBtn.Size = UDim2.new(0, 140, 0, 40)
    toggleBtn.Position = UDim2.new(0, 20, 0, 10)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    toggleBtn.BorderSizePixel = 0
    toggleBtn.Text = "ZalHub [ON]"
    toggleBtn.TextColor3 = library.accent
    toggleBtn.Font = Enum.Font.Code
    toggleBtn.TextSize = 16
    toggleBtn.ZIndex = 100
    toggleBtn.Parent = toggleGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = toggleBtn

    local stroke = Instance.new("UIStroke")
    stroke.Color = library.accent
    stroke.Thickness = 1
    stroke.Parent = toggleBtn

    local isOpen = true

    local function toggleWindow()
        isOpen = not isOpen
        holder.Visible = isOpen

        if isOpen then
            toggleBtn.Text = "ZalHub [ON]"
            toggleBtn.TextColor3 = library.accent
            stroke.Color = library.accent
        else
            toggleBtn.Text = "ZalHub [OFF]"
            toggleBtn.TextColor3 = Color3.fromRGB(80, 80, 80)
            stroke.Color = Color3.fromRGB(80, 80, 80)
        end
    end

    toggleBtn.MouseButton1Click:Connect(toggleWindow)

    services.UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if input.KeyCode == Enum.KeyCode.RightShift then
            toggleWindow()
        end
    end)

    utility.dragify(toggleBtn, toggleBtn)

    local border = utility.create("Frame", {
        Size = UDim2.new(1, 4, 1, 4),
        Position = UDim2.new(0, -2, 0, -2),
        BackgroundColor3 = Color3.fromRGB(255,255,255),
        BorderSizePixel = 0,
        ZIndex = 0,
        Parent = holder
    })
    local borderGradient = utility.create("UIGradient", {
        Rotation = 0,
        Color = utility.gradient(library.outline),
        Parent = border
    })

    task.spawn(function()
        while true do
            utility.tween(borderGradient, {4, Enum.EasingStyle.Linear}, {Rotation = 360})
            wait(4)
            borderGradient.Rotation = 0
        end
    end)

    local mainBG = utility.create("Frame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = Color3.fromRGB(15, 15, 15),
        BorderSizePixel = 0,
        ZIndex = 1,
        Parent = holder
    })

    local topBar = utility.create("Frame", {
        Size = UDim2.new(1, 0, 0, 50),
        BackgroundColor3 = Color3.fromRGB(20, 20, 20),
        BorderSizePixel = 0,
        ZIndex = 2,
        Parent = mainBG
    })
    utility.stroke(topBar, Color3.fromRGB(40, 40, 40), 1)

    utility.create("TextLabel", {
        Size = UDim2.new(0, 160, 1, 0),
        Position = UDim2.new(0, 16, 0, 0),
        BackgroundTransparency = 1,
        Text = name,
        TextColor3 = library.accent,
        TextSize = 18,
        Font = Enum.Font.Code,
        TextStrokeTransparency = 0.5,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 3,
        Parent = topBar
    })

    -- Global Search Bar (Per-Tab search removed in favor of this)
    local searchFrame = utility.create("Frame", {
        Name = "GlobalSearch",
        Size = UDim2.new(0, 200, 0, 30),
        Position = UDim2.new(0, 175, 0, 10),
        BackgroundColor3 = Color3.fromRGB(18, 18, 18),
        ZIndex = 3,
        Parent = topBar
    })
    utility.stroke(searchFrame, Color3.fromRGB(50, 50, 50), 1)

    local searchIcon = utility.create("TextLabel", {
        Size = UDim2.new(0, 30, 1, 0),
        BackgroundTransparency = 1,
        Text = "üîç",
        TextSize = 14,
        TextColor3 = Color3.fromRGB(100, 100, 100),
        Font = Enum.Font.Code,
        TextXAlignment = Enum.TextXAlignment.Center,
        ZIndex = 4,
        Parent = searchFrame
    })

    local searchBox = utility.create("TextBox", {
        Size = UDim2.new(1, -30, 1, 0),
        Position = UDim2.new(0, 30, 0, 0),
        BackgroundTransparency = 1,
        Text = "",
        PlaceholderText = "Search Sections...",
        PlaceholderColor3 = Color3.fromRGB(80, 80, 80),
        TextColor3 = Color3.fromRGB(200, 200, 200),
        TextSize = 14,
        Font = Enum.Font.Code,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 4,
        Parent = searchFrame
    })

    searchBox:GetPropertyChangedSignal("Text"):Connect(function()
        local query = string.lower(searchBox.Text)
        
        if query == "" then
            for _, tab in pairs(tabContainer:GetChildren()) do
                if tab:IsA("TextButton") then
                    tab.Visible = true
                end
            end
        else
            for _, tab in pairs(tabContainer:GetChildren()) do
                if tab:IsA("TextButton") then
                    if not string.find(string.lower(tab.Text), query) then
                        tab.Visible = false
                    else
                        tab.Visible = true
                    end
                end
            end
        end
    end)

    local tabContainer = utility.create("Frame", {
        Size = UDim2.new(1, -370, 1, 0), -- Reduced width to fit search bar
        Position = UDim2.new(0, 375, 0, 0),
        BackgroundTransparency = 1,
        ZIndex = 3,
        ClipsDescendants = true, 
        Parent = topBar
    })
    utility.create("UIListLayout", {
        FillDirection = Enum.FillDirection.Horizontal,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 15), 
        VerticalAlignment = Enum.VerticalAlignment.Center,
        Parent = tabContainer
    })

    local content = utility.create("Frame", {
        Size = UDim2.new(1, -20, 1, -80),
        Position = UDim2.new(0, 10, 0, 65),
        BackgroundTransparency = 1,
        ZIndex = 2,
        Parent = mainBG
    })

    utility.dragify(holder, topBar)

    local currentTab = nil
    local windowActions = {}

    function windowActions:Tab(tabName)
        local tabBtn = utility.create("TextButton", {
            Size = UDim2.new(0, 0, 0, 35), 
            AutomaticSize = Enum.AutomaticSize.X, 
            BackgroundTransparency = 1,
            Text = tabName,
            TextColor3 = Color3.fromRGB(120, 120, 120),
            TextSize = 15,
            Font = Enum.Font.Code,
            TextXAlignment = Enum.TextXAlignment.Center, 
            ZIndex = 4,
            Parent = tabContainer
        })

        local underline = utility.create("Frame", {
            Size = UDim2.new(1, 0, 0, 3),
            Position = UDim2.new(0, 0, 1, 2),
            BackgroundColor3 = library.accent,
            BorderSizePixel = 0,
            BackgroundTransparency = 1,
            ZIndex = 4,
            Parent = tabBtn
        })

        local tabFrame = utility.create("Frame", {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Visible = false,
            ZIndex = 2,
            Parent = content
        })

        local leftCol = utility.create("ScrollingFrame", {
            Size = UDim2.new(0.5, -2, 1, 0),
            Position = UDim2.new(0, 0, 0, 0),
            BackgroundTransparency = 1,
            ScrollBarThickness = 0,
            ScrollBarImageColor3 = Color3.fromRGB(50, 50, 50),
            Visible = true,
            ZIndex = 3,
            Parent = tabFrame
        })
        leftCol.CanvasSize = UDim2.new(0, 0, 0, 1000)

        local rightCol = utility.create("ScrollingFrame", {
            Size = UDim2.new(0.5, -2, 1, 0),
            Position = UDim2.new(0.5, 2, 0, 0),
            BackgroundTransparency = 1,
            ScrollBarThickness = 0,
            ScrollBarImageColor3 = Color3.fromRGB(50, 50, 50),
            Visible = true,
            ZIndex = 3,
            Parent = tabFrame
        })
        rightCol.CanvasSize = UDim2.new(0, 0, 0, 1000)

        utility.create("UIPadding", {
            Parent = leftCol,
            PaddingLeft = UDim.new(0, 1),
            PaddingRight = UDim.new(0, 1),
            PaddingTop = UDim.new(0, 10),
            PaddingBottom = UDim.new(0, 10)
        })

        utility.create("UIPadding", {
            Parent = rightCol,
            PaddingLeft = UDim.new(0, 1),
            PaddingRight = UDim.new(0, 1),
            PaddingTop = UDim2.new(0, 10),
            PaddingBottom = UDim.new(0, 10)
        })

        local leftList = utility.create("UIListLayout", {
            FillDirection = Enum.FillDirection.Vertical,
            HorizontalAlignment = Enum.HorizontalAlignment.Left,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 10),
            Parent = leftCol
        })

        local rightList = utility.create("UIListLayout", {
            FillDirection = Enum.FillDirection.Vertical,
            HorizontalAlignment = Enum.HorizontalAlignment.Left,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 10),
            Parent = rightCol
        })

        local function updateCanvas()
            leftCol.CanvasSize = UDim2.new(0, 0, 0, leftList.AbsoluteContentSize.Y + 20)
            rightCol.CanvasSize = UDim2.new(0, 0, 0, rightList.AbsoluteContentSize.Y + 20)
        end

        leftList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateCanvas)
        rightList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateCanvas)

        local function select()
            if currentTab then
                currentTab.Frame.Visible = false
                utility.tween(currentTab.Btn, {0.2}, {TextColor3 = Color3.fromRGB(120, 120, 120)})
                utility.tween(currentTab.Line, {0.2}, {BackgroundTransparency = 1})
            end
            tabFrame.Visible = true

            leftCol.Visible = true
            rightCol.Visible = true

            leftCol.CanvasPosition = Vector2.new(0, 0)
            rightCol.CanvasPosition = Vector2.new(0, 0)

            updateCanvas()

            utility.tween(tabBtn, {0.2}, {TextColor3 = library.accent})
            utility.tween(underline, {0.2}, {BackgroundTransparency = 0})
            currentTab = {Frame = tabFrame, Btn = tabBtn, Line = underline}
        end

        tabBtn.MouseButton1Click:Connect(select)
        if not currentTab then select() end

        local tabActions = {}
        local currentSectionIndex = 0

        function tabActions:ConfigManager()
            local configSection = tabActions:Section("Configuration Manager")
            
            -- 1. Config Name Input
            configSection:Textbox("Config Name", "config_name", "My Config", function() end)
            
            -- 2. Create / Overwrite / Delete Buttons
            configSection:Button("Create / Overwrite Config", function()
                local name = library.flags.config_name
                if name and name ~= "" then
                    if saveConfig(name) then
                        library:Notify({
                            Title = "Success",
                            Content = "Saved config: " .. name,
                            Duration = 3
                        })
                        if refreshConfigCallback then refreshConfigCallback() end
                    else
                        library:Notify({
                            Title = "Error",
                            Content = "Failed to create config.",
                            Duration = 5
                        })
                    end
                else
                    library:Notify({Title = "Error", Content = "Please type a name.", Duration = 3})
                end
            end)

            configSection:Button("Delete Selected", function()
                local name = library.flags.selected_config
                if name and name ~= "No Configs" then
                    if deleteConfig(name) then
                        library:Notify({
                            Title = "Deleted",
                            Content = "Config deleted: " .. name,
                            Duration = 3
                        })
                        if refreshConfigCallback then refreshConfigCallback() end
                    end
                end
            end)

            -- 3. Dropdown List
            local initialList = getFiles()
            if #initialList == 0 then table.insert(initialList, "No Configs") end

            configSection:Dropdown("Select Config", "selected_config", initialList, function(selected)
                library.flags.selected_config = selected
            end)

            -- 4. Load Button
            configSection:Button("Load Selected", function()
                local name = library.flags.selected_config
                if name and name ~= "No Configs" then
                    if loadConfig(name) then
                        library:Notify({Title = "Loaded", Content = "Loaded: " .. name, Duration = 3})
                    else
                        library:Notify({Title = "Error", Content = "Failed to load.", Duration = 5})
                    end
                end
            end)

            -- 5. Refresh Button
            configSection:Button("Refresh List", function()
                if refreshConfigCallback then refreshConfigCallback() end
                library:Notify({Title = "Refresh", Content = "Config list updated.", Duration = 2})
            end)

            -- 6. Auto Load Button
            configSection:Button("Set Auto-Load", function()
                local name = library.flags.selected_config
                if name and name ~= "No Configs" then
                    setAutoload(name)
                    library:Notify({Title = "Auto-Load", Content = "Will auto-load: " .. name, Duration = 3})
                end
            end)
        end

        function tabActions:Section(sectionName)
            local targetCol = currentSectionIndex % 2 == 0 and leftCol or rightCol
            currentSectionIndex = currentSectionIndex + 1

            local sectionFrame = utility.create("Frame", {
                Name = "ZalSection", 
                BackgroundColor3 = Color3.fromRGB(18, 18, 18),
                BorderSizePixel = 0,
                AutomaticSize = Enum.AutomaticSize.Y,
                Size = UDim2.new(1, 0, 0, 0),
                ZIndex = 4,
                Parent = targetCol
            })
            utility.stroke(sectionFrame, Color3.fromRGB(40, 40, 40), 1)

            utility.create("TextLabel", {
                Size = UDim2.new(1, -2, 0, 35),
                Position = UDim2.new(0, 1, 0, 0),
                BackgroundTransparency = 1,
                Text = sectionName:upper(),
                TextColor3 = library.accent,
                TextSize = 15,
                Font = Enum.Font.Code,
                TextXAlignment = Enum.TextXAlignment.Left,
                ZIndex = 5,
                Parent = sectionFrame
            })

            local items = utility.create("Frame", {
                Size = UDim2.new(1, -2, 0, 0),
                Position = UDim2.new(0, 1, 0, 35),
                BackgroundTransparency = 1,
                AutomaticSize = Enum.AutomaticSize.Y,
                ZIndex = 5,
                Parent = sectionFrame
            })
            local itemLayout = utility.create("UIListLayout", {
                Padding = UDim.new(0, 0),
                SortOrder = Enum.SortOrder.LayoutOrder,
                Parent = items
            })

            local sectionActions = {}

            function sectionActions:Toggle(text, flag, callback)
                local toggle = utility.create("TextButton", {
                    Size = UDim2.new(1, 0, 0, 30),
                    BackgroundTransparency = 1,
                    Text = "",
                    ZIndex = 6,
                    Parent = items
                })
                local box = utility.create("Frame", {
                    Size = UDim2.new(0, 18, 0, 18),
                    Position = UDim2.new(0, 0, 0.5, -9),
                    BackgroundColor3 = Color3.fromRGB(25, 25, 25),
                    BorderSizePixel = 0,
                    ZIndex = 7,
                    Parent = toggle
                })
                utility.stroke(box, Color3.fromRGB(50, 50, 50), 1)

                local fill = utility.create("Frame", {
                    Size = UDim2.new(1, -4, 1, -4),
                    Position = UDim2.new(0, 2, 0, 2),
                    BackgroundColor3 = library.accent,
                    BorderSizePixel = 0,
                    BackgroundTransparency = 1,
                    ZIndex = 8,
                    Parent = box
                })
                utility.create("TextLabel", {
                    Size = UDim2.new(1, -30, 1, 0),
                    Position = UDim2.new(0, 30, 0, 0),
                    BackgroundTransparency = 1,
                    Text = text,
                    TextColor3 = Color3.fromRGB(180, 180, 180),
                    TextSize = 14,
                    Font = Enum.Font.Code,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 7,
                    Parent = toggle
                })

                -- Registry Hook
                library.registry.toggles[flag] = {
                    fill = fill,
                    callback = callback
                }

                local enabled = false
                toggle.MouseButton1Click:Connect(function()
                    enabled = not enabled
                    utility.tween(fill, {0.2}, {BackgroundTransparency = enabled and 0 or 1})
                    library.flags[flag] = enabled
                    -- SYNC LOGIC
                    if getgenv().Registry and getgenv().Registry[flag] then
                        getgenv()[getgenv().Registry[flag]] = enabled
                    end
                    callback(enabled)
                end)
            end

            function sectionActions:Textbox(text, flag, placeholder, callback)
                local textboxFrame = utility.create("Frame", {
                    Size = UDim2.new(1, 0, 0, 50),
                    BackgroundTransparency = 1,
                    ZIndex = 6,
                    Parent = items
                })
                utility.create("TextLabel", {
                    Size = UDim2.new(1, 0, 0, 20),
                    BackgroundTransparency = 1,
                    Text = text,
                    TextColor3 = Color3.fromRGB(180, 180, 180),
                    TextSize = 14,
                    Font = Enum.Font.Code,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 7,
                    Parent = textboxFrame
                })
                local box = utility.create("TextBox", {
                    Size = UDim2.new(1, 0, 0, 24),
                    Position = UDim2.new(0, 0, 0, 22),
                    BackgroundColor3 = Color3.fromRGB(25, 25, 25),
                    BorderSizePixel = 0,
                    PlaceholderText = placeholder or "...",
                    Text = "",
                    TextColor3 = Color3.fromRGB(220, 220, 220),
                    PlaceholderColor3 = Color3.fromRGB(80, 80, 80),
                    TextSize = 14,
                    Font = Enum.Font.Code,
                    ZIndex = 7,
                    Parent = textboxFrame
                })
                utility.stroke(box, Color3.fromRGB(50, 50, 50), 1)
                box.FocusLost:Connect(function()
                    library.flags[flag] = box.Text
                    callback(box.Text)
                end)
            end

            function sectionActions:Dropdown(text, flag, list, callback)
                local dropdown = utility.create("Frame", {
                    Size = UDim2.new(1, 0, 0, 50),
                    BackgroundTransparency = 1,
                    ZIndex = 6,
                    Parent = items
                })
                utility.create("TextLabel", {
                    Size = UDim2.new(1, 0, 0, 20),
                    BackgroundTransparency = 1,
                    Text = text,
                    TextColor3 = Color3.fromRGB(180, 180, 180),
                    TextSize = 14,
                    Font = Enum.Font.Code,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 7,
                    Parent = dropdown
                })
                local btn = utility.create("TextButton", {
                    Size = UDim2.new(1, 0, 0, 24),
                    Position = UDim2.new(0, 0, 0, 22),
                    BackgroundColor3 = Color3.fromRGB(25, 25, 25),
                    BorderSizePixel = 0,
                    Text = "Select...",
                    TextColor3 = Color3.fromRGB(200, 200, 200),
                    TextSize = 14,
                    Font = Enum.Font.Code,
                    ZIndex = 7,
                    Parent = dropdown
                })
                utility.stroke(btn, Color3.fromRGB(50, 50, 50), 1)

                -- Registry Hook
                library.registry.dropdowns[flag] = {
                    btn = btn,
                    callback = callback
                }

                local maxDropdownHeight = 200
                local contentHeight = #list * 24

                local listFrame = utility.create("ScrollingFrame", {
                    Size = UDim2.new(1, 0, 0, contentHeight),
                    Position = UDim2.new(0, 0, 1, 4),
                    BackgroundColor3 = Color3.fromRGB(20, 20, 20),
                    BorderSizePixel = 0,
                    Visible = false,
                    ZIndex = 11,
                    ScrollBarThickness = 5,
                    ScrollBarImageColor3 = Color3.fromRGB(60, 60, 60),
                    ScrollBarImageTransparency = 0.5,
                    CanvasSize = UDim2.new(1, 0, 0, contentHeight),
                    Parent = btn
                })
                utility.stroke(listFrame, Color3.fromRGB(50, 50, 50), 1)
                utility.create("UIListLayout", {
                    Padding = UDim.new(0, 2),
                    Parent = listFrame
                })

                local opened = false
                btn.MouseButton1Click:Connect(function()
                    opened = not opened
                    listFrame.Visible = opened

                    if opened then
                        listFrame.Size = UDim2.new(1, 0, 0, math.min(contentHeight, maxDropdownHeight))
                        listFrame.CanvasSize = UDim2.new(1, 0, 0, contentHeight)
                        listFrame.CanvasPosition = Vector2.new(0, 0)
                    else
                        listFrame.Size = UDim2.new(1, 0, 0, 0)
                    end
                end)

                -- Function to repopulate the dropdown (used for Refresh)
                local function refreshDropdownList(newList)
                    -- Clear existing
                    for _, child in pairs(listFrame:GetChildren()) do
                        if child:IsA("TextButton") then
                            child:Destroy()
                        end
                    end
                    
                    -- Create new buttons
                    for _, v in next, newList do
                        local item = utility.create("TextButton", {
                            Size = UDim2.new(1, 0, 0, 24),
                            BackgroundColor3 = Color3.fromRGB(20, 20, 20),
                            BorderSizePixel = 0,
                            Text = v,
                            TextColor3 = Color3.fromRGB(160, 160, 160),
                            TextSize =  Manager:Dropdown("Select Config", "selected_config", ...)) end

                end
                    local item = utility.create("TextButton", {
                            Size = UDim2.new(1, 0, 0, 24),
                            BackgroundColor3 = Color3.fromRGB(20, 20, 20),
                            BorderSize = Create("TextButton", ...) -- ERROR in previous logic, simplified below
                            Text = v,
                            TextColor3 = Color3.fromRGB(160, 160, 160),
                            TextSize = 14,
                            Font = Enum.Font.Code,
                            ZIndex = 12,
                            Parent = listFrame
                        })
                        item.MouseButton1Click:Connect(function()
                            btn.Text = v
                            opened = false
                            listFrame.Visible = false
                            listFrame.Size = Button("Create Config", ...) -- ERROR in previous logic, simplified below
                            btn.Text = v
                            opened = false
                            listFrame.Visible = false
                            listFrame.Size = UDim2.new(1, 0, 0, 0)
                            library.flags[flag] = v
                            callback(v)
                        end)
                    end
                    
                    -- Update height
                    contentHeight = #newList * 24
                    if opened then
                        listFrame.Size = UDim2.new(1, 0, 0, math.min(contentHeight, maxDropdownHeight))
                        listFrame.CanvasSize = UDim2.new(1, 0, 0, contentHeight)
                    end
                end

                -- Hook refresh for Config Manager specifically
                if text == "Select Config" then
                    refreshConfigCallback = function()
                        local newFiles = getFiles()
                        refreshDropdownList(newFiles)
                    end
                end

                -- Initial population
                for _, v in next, list do
                    local item = utility.create("TextButton", {
                        Size = UDim2.new(1, 0, 0, 24),
                        BackgroundColor3 = Color3.fromRGB(20, 20, 20),
                        BorderSizePixel = 0,
                        Text = v,
                        TextColor3 = Color3.fromRGB(160, 160, 160),
                        TextSize = 14,
                        Font = Enum.Font.Code,
                        ZIndex = 12,
                        Parent = listFrame
                    })
                    item.MouseButton1Click:Connect(function()
                        btn.Text = v
                        opened = false
                        listFrame.Visible = false
                        listFrame.Size = UDim2.new(1, 0, 0, 0)
                        library.flags[flag] = v
                        callback(v)
                    end)
                end
            end

            function sectionActions:Slider(text, flag, min, max, default, callback)
                local slider = utility.create("Frame", {
                    Size = UDim2.new(1, 0, 0, 55),
                    BackgroundTransparency = 1,
                    ZIndex = 6,
                    Parent = items
                })
                utility.create("TextLabel", {
                    Size = UDim2.new(1, 0, 0, 20),
                    BackgroundTransparency = 1,
                    Text = text,
                    TextColor3 = Color3.fromRGB(180, 180, 180),
                    TextSize = 14,
                    Font = Enum.Font.Code,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 7,
                    Parent = slider
                })
                local bg = utility.create("TextButton", {
                    Size = UDim2.new(1, 0, 0, 20),
                    Position = UDim2.new(0, 0, 0, 25),
                    BackgroundColor3 = Color3.fromRGB(25, 25, 25),
                    BorderSizePixel = 0,
                    Text = "",
                    ZIndex = 7,
                    Parent = slider
                })
                utility.stroke(bg, Color3.fromRGB(50, 50, 50), 1)

                local fill = utility.create("Frame", {
                    Size = UDim2.new((default - min) / (max - min), 0, 1, 0),
                    BackgroundColor3 = library.accent,
                    BorderSizePixel = 0,
                    ZIndex = 8,
                    Parent = bg
                })
                local val = utility.create("TextLabel", {
                    Size = UDim2.new(1, 0, 1, 0),
                    BackgroundTransparency = 1,
                    Text = string.format("%.2f", default),
                    TextColor3 = Color3.fromRGB(255,255,255),
                    TextSize = 13,
                    Font = Enum.Font.Code,
                    ZIndex = 9,
                    Parent = bg
                })

                -- Registry Hook
                library.registry.sliders[flag] = {
                    fill = fill,
                    val = val,
                    callback = callback,
                    min = min,
                    max = max
                }

                local function update(input)
                    local perc = math.clamp((input.Position.X - bg.AbsolutePosition.X) / bg.AbsoluteSize.X,0,1)
                    local rawValue = min + (max - min) * perc
                    local value = tonumber(string.format("%.2f", rawValue))
                    utility.tween(fill, {0.1}, {Size = UDim2.new(perc, 0, 1, 0)})
                    val.Text = string.format("%.2f", value)
                    library.flags[flag] = value
                    
                    -- SYNC LOGIC
                    if getgenv().Registry and getgenv().Registry[flag] then
                        local varName = getgenv().Registry[flag]
                        -- Specific Logic to update Builder Config
                        if varName == "GRIDS_X" and getgenv().BuilderConfig then getgenv().BuilderConfig.GRIDS_X = math.floor(value) end
                        if varName == "GRIDS_Z" and getgenv().BuilderConfig then getgenv().BuilderConfig.GRIDS_Z = math.floor(value) end
                    else
                        getgenv()[varName] = value
                        end
                    end
                    
                    callback(value)
                end

                local dragging = false
                bg.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = true
                        update(input)
                    end
                end)
                services.UserInputService.InputChanged:Connect(function(input)
                    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                        update(input)
                    end
                end)
                services.UserInputService.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = false end
                end)
            end

            function sectionActions:Button(text, callback)
                local btn = utility.create("TextButton", {
                    Size = UDim2(new(1, 0, 0, 34),
                    BackgroundColor3 = Color3.fromRGB(25, 25, 25),
                    BorderSizePixel = 0,
                    Text = text,
                    TextColor3 = Color3.fromRGB(200, 200, 200),
                    TextSize = 14,
                    Font = Enum.Font.Code,
                    ZIndex = 6,
                    Parent = items
                })
                utility.stroke(btn, Color3.fromRGB(50, 50, 50), 1)
                btn.MouseButton1Click:Connect(callback)
            end

            return sectionActions
        end

        return tabActions
    end

    -- Auto-load logic (Startup + Character Spawn)
    local function tryAutoLoad()
        local autoName = getAutoload()
        if autoName then
            wait(1) -- Wait a moment for UI to init
            if loadConfig(autoName) then
                library:Notify({
                    Title = "Auto-Load",
                    Content = "Auto-loaded config: " .. autoName,
                    Duration = 5
                })
            end
        end
    end

    -- Run on startup
    task.spawn(tryAutoLoad)

    -- Run on respawn
    game:GetService("Players").LocalPlayer.CharacterAdded:Connect(tryAutoLoad)

    return windowActions
end

return library
